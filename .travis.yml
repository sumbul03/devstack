sudo: required

language: python

python:
  - "3.5"

env:
  - DEVSTACK_WORKSPACE=/tmp DOCKER_COMPOSE_VERSION=1.13.0 SHALLOW_CLONE=1 DEVSTACK='lms'
  - DEVSTACK_WORKSPACE=/tmp DOCKER_COMPOSE_VERSION=1.13.0 SHALLOW_CLONE=1 DEVSTACK='analytics_pipeline'
  - BITBUCKET_CLONE_DIR=/tmp

services:
  - docker

before_install:
  # Upgrade Docker to the latest version
  - pwd
  - docker version
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
  - docker version

  # Upgrade Docker Compose to the latest version
  - docker-compose --version
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker-compose --version
  - git log
  - make requirements
  - make dev.clone
  - if [[ $DEVSTACK == 'lms' ]]; then make pull; fi
  - if [[ $DEVSTACK == 'analytics_pipeline' ]]; then make dev.up.analytics_pipeline; fi
  - make e2e-tests
  

script:
  - "./.travis/run.sh"
  - pycodestyle
  - paver install_pages
  - pylint regression/
  
after_success:
  - if [ "$TRAVIS_PULL_REQUEST" == "false" ] && [ "$TRAVIS_BRANCH" == "open-release/hawthorn.master" ]; then
    docker --version;
    sudo apt-get -y update;
    sudo apt-get -y install -o Dpkg::Options::="--force-confnew" docker-ce=18.03.0~ce-0~ubuntu;
    docker --version;
    docker-compose build;
    docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASS";
    docker push edxops/e2e:latest;
    fi
